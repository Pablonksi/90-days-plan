import React, { useState, useEffect, useRef } from 'react';
import { 
  CheckCircle, 
  Circle, 
  Trophy, 
  Flame, 
  Utensils, 
  AlertTriangle, 
  Dumbbell, 
  RotateCcw,
  Zap,
  Play,
  Pause,
  X,
  Copy,
  Download,
  Upload,
  Settings as SettingsIcon,
  Layout,
  Key,
  Heart,
  ClipboardList
} from 'lucide-react';

const App = () => {
  // --- STATE & PERSISTENCE ---
  const [activeView, setActiveView] = useState('workout'); // 'workout', 'habits', 'settings'
  
  const [completedTasks, setCompletedTasks] = useState(() => {
    const saved = localStorage.getItem('marchPhysiqueV7_tasks');
    return saved ? JSON.parse(saved) : {};
  });

  const [guiScale, setGuiScale] = useState(() => {
    const saved = localStorage.getItem('marchPhysiqueV7_scale');
    return saved ? parseFloat(saved) : 2.0; 
  });

  const [setCounts, setSetCounts] = useState(() => {
    const saved = localStorage.getItem('marchPhysiqueV7_sets');
    return saved ? JSON.parse(saved) : {};
  });

  const [activeTab, setActiveTab] = useState('monday');
  const [focusTask, setFocusTask] = useState(null);
  const [saveKeyInput, setSaveKeyInput] = useState('');
  const [syncStatus, setSyncStatus] = useState('');
  
  const [timeLeft, setTimeLeft] = useState(0);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const timerRef = useRef(null);

  // Auto-save
  useEffect(() => {
    localStorage.setItem('marchPhysiqueV7_tasks', JSON.stringify(completedTasks));
    localStorage.setItem('marchPhysiqueV7_scale', guiScale.toString());
    localStorage.setItem('marchPhysiqueV7_sets', JSON.stringify(setCounts));
  }, [completedTasks, guiScale, setCounts]);

  // Timer logic
  useEffect(() => {
    if (isTimerRunning && timeLeft > 0) {
      timerRef.current = setInterval(() => setTimeLeft(p => p - 1), 1000);
    } else {
      clearInterval(timerRef.current);
      if (timeLeft === 0) setIsTimerRunning(false);
    }
    return () => clearInterval(timerRef.current);
  }, [isTimerRunning, timeLeft]);

  // --- SAVE SYSTEM ---
  const generateSaveKey = () => {
    const data = { c: completedTasks, g: guiScale, sc: setCounts, v: 7 };
    return btoa(JSON.stringify(data));
  };

  const copyKey = () => {
    const key = generateSaveKey();
    const el = document.createElement('textarea');
    el.value = key;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    setSyncStatus('Key Copied!');
    setTimeout(() => setSyncStatus(''), 2000);
  };

  const importKey = () => {
    try {
      const decoded = JSON.parse(atob(saveKeyInput.trim()));
      if (decoded.c) setCompletedTasks(decoded.c);
      if (decoded.sc) setSetCounts(decoded.sc);
      if (decoded.g) setGuiScale(decoded.g);
      setSyncStatus('Import Successful!');
      setSaveKeyInput('');
    } catch (e) {
      setSyncStatus('Invalid Key');
    }
  };

  // --- ROUTINE DATA (Updated for 3 sets Daily Abs) ---
  const absRoutine = [
    { id: 'abs1', name: 'Plank (45s)', icon: '‚è±Ô∏è', type: 'time', goal: 45, sets: 3 },
    { id: 'abs2', name: 'Leg Raises (15)', icon: 'ü¶µ', type: 'reps', goal: 15, sets: 3 },
    { id: 'abs3', name: 'Dead Bugs (15)', icon: 'üêú', type: 'reps', goal: 15, sets: 3 },
    { id: 'abs4', name: 'Flutter Kicks (30s)', icon: 'üåä', type: 'time', goal: 30, sets: 3 },
    { id: 'abs5', name: 'Mountain Climber (30s)', icon: 'üèîÔ∏è', type: 'time', goal: 30, sets: 3 },
    { id: 'abs6', name: 'Slow Crunches (20)', icon: 'üìâ', type: 'reps', goal: 20, sets: 3 },
  ];

  const fullBodyRoutine = [
    { id: 'fb1', name: 'Push-Ups', icon: 'üí™', type: 'reps', goal: '3x12', sets: 3 },
    { id: 'fb2', name: 'DB Shoulder Press', icon: '‚¨ÜÔ∏è', type: 'reps', goal: '3x12', sets: 3 },
    { id: 'fb3', name: 'Dumbbell Rows', icon: 'üö£', type: 'reps', goal: '3x12', sets: 3 },
    { id: 'fb4', name: 'Goblet Squat', icon: 'üç∑', type: 'reps', goal: '3x15', sets: 3, kneeWarning: true },
    { id: 'fb5', name: 'Dead Bugs', icon: 'üêú', type: 'reps', goal: '3x15', sets: 3 },
    { id: 'fb6', name: 'Plank (1 min)', icon: '‚è±Ô∏è', type: 'time', goal: 60, sets: 1 },
  ];

  const dietHabits = [
    { id: 'h1', name: '1800 Calories', icon: 'üçΩÔ∏è' },
    { id: 'h2', name: '120g Protein', icon: 'ü•ö' },
    { id: 'h3', name: '2L Water', icon: 'üíß' },
    { id: 'h4', name: '8h Sleep', icon: 'üåô' },
  ];

  const days = [
    { id: 'monday', label: 'Mon', fullBody: true },
    { id: 'tuesday', label: 'Tue', fullBody: false },
    { id: 'wednesday', label: 'Wed', fullBody: true },
    { id: 'thursday', label: 'Thu', fullBody: false },
    { id: 'friday', label: 'Fri', fullBody: false },
    { id: 'saturday', label: 'Sat', fullBody: true },
    { id: 'sunday', label: 'Sun', fullBody: false },
  ];

  // GUI Scaling Calculation
  const visualScale = 0.5 + (guiScale * 0.25);

  return (
    <div className="min-h-screen bg-black text-white font-sans overflow-x-hidden pb-24">
      
      {/* Scaling Container for Main Content */}
      <div 
        style={{ transform: `scale(${visualScale})`, transformOrigin: 'top center', transition: 'transform 0.2s ease' }}
        className="max-w-md mx-auto min-h-screen flex flex-col px-4 pt-8"
      >
        
        {/* TOP HEADER */}
        <div className="text-center mb-8">
          <h1 className="text-3xl font-black italic tracking-tighter text-blue-500 flex items-center justify-center gap-2 uppercase">
            Physique <Flame className="text-orange-500 fill-orange-500" /> V7
          </h1>
          <p className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mt-1 italic">Abs & Core: 3 Sets Standard</p>
        </div>

        {activeView === 'workout' && (
          <>
            {/* Day Bar */}
            <div className="flex justify-between gap-1 mb-6 overflow-x-auto no-scrollbar pb-2">
              {days.map(d => (
                <button
                  key={d.id}
                  onClick={() => { setActiveTab(d.id); setFocusTask(null); }}
                  className={`flex-1 min-w-[48px] py-4 rounded-2xl flex flex-col items-center transition-all ${
                    activeTab === d.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20' : 'bg-zinc-900 text-zinc-500'
                  }`}
                >
                  <span className="text-[9px] font-black uppercase">{d.label}</span>
                </button>
              ))}
            </div>

            {/* Routine List */}
            <div className="space-y-3">
              <h3 className="text-[10px] font-black text-zinc-500 uppercase tracking-widest ml-2 mb-1">Abs & Core (3 Sets)</h3>
              {absRoutine.map(task => (
                <div 
                  key={task.id + activeTab} 
                  onClick={() => setFocusTask({...task, day: activeTab})}
                  className="flex items-center p-4 bg-zinc-900 rounded-2xl border border-zinc-800 hover:border-zinc-700 transition-all cursor-pointer"
                >
                  <span className="text-2xl mr-4">{task.icon}</span>
                  <div className="flex-1">
                    <h4 className="text-sm font-black uppercase italic text-zinc-100">{task.name}</h4>
                  </div>
                  <button onClick={(e) => { e.stopPropagation(); setCompletedTasks(p => ({...p, [task.id + activeTab]: !p[task.id + activeTab]}))}}>
                    {completedTasks[task.id + activeTab] ? <CheckCircle className="text-blue-500" /> : <Circle className="text-zinc-700" />}
                  </button>
                </div>
              ))}

              {days.find(d => d.id === activeTab).fullBody && (
                <>
                  <h3 className="text-[10px] font-black text-blue-500 uppercase tracking-widest ml-2 mt-6 mb-1">Full Body Schedule</h3>
                  {fullBodyRoutine.map(task => (
                    <div 
                      key={task.id + activeTab} 
                      onClick={() => setFocusTask({...task, day: activeTab})}
                      className="flex items-center p-4 bg-zinc-900 rounded-2xl border border-zinc-800 hover:border-zinc-700 transition-all cursor-pointer"
                    >
                      <span className="text-2xl mr-4">{task.icon}</span>
                      <div className="flex-1">
                        <h4 className="text-sm font-black uppercase italic text-zinc-100">{task.name}</h4>
                        <p className="text-[10px] text-blue-500 font-bold uppercase">{task.goal}</p>
                      </div>
                      <button onClick={(e) => { e.stopPropagation(); setCompletedTasks(p => ({...p, [task.id + activeTab]: !p[task.id + activeTab]}))}}>
                        {completedTasks[task.id + activeTab] ? <CheckCircle className="text-blue-500" /> : <Circle className="text-zinc-700" />}
                      </button>
                    </div>
                  ))}
                </>
              )}
            </div>
          </>
        )}

        {activeView === 'habits' && (
          <div className="space-y-4">
            <h2 className="text-xl font-black italic uppercase text-white mb-6">Daily Diet & Habits</h2>
            {dietHabits.map(habit => (
              <div 
                key={habit.id + activeTab}
                className="flex items-center p-5 bg-zinc-900 border border-zinc-800 rounded-3xl"
              >
                <span className="text-3xl mr-4">{habit.icon}</span>
                <div className="flex-1">
                  <h4 className="text-lg font-black italic uppercase">{habit.name}</h4>
                </div>
                <button onClick={() => setCompletedTasks(p => ({...p, [habit.id + activeTab]: !p[habit.id + activeTab]}))}>
                  {completedTasks[habit.id + activeTab] ? <CheckCircle size={28} className="text-blue-500" /> : <Circle size={28} className="text-zinc-700" />}
                </button>
              </div>
            ))}
          </div>
        )}

        {activeView === 'settings' && (
          <div className="space-y-6">
            <h2 className="text-xl font-black italic uppercase flex items-center gap-2">
              <SettingsIcon className="text-blue-500" /> Preferences
            </h2>

            <div className="bg-zinc-900 border border-zinc-800 rounded-3xl p-5">
              <div className="flex justify-between items-center mb-3">
                <span className="text-xs font-black uppercase text-zinc-500 flex items-center gap-2">
                  <Layout size={14} className="text-blue-500" /> GUI Scale
                </span>
                <span className="text-sm font-black text-blue-400">{guiScale.toFixed(1)}x</span>
              </div>
              <input 
                type="range" min="1" max="3" step="0.1" value={guiScale} 
                onChange={(e) => setGuiScale(parseFloat(e.target.value))}
                className="w-full h-1.5 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-blue-500"
              />
            </div>

            <div className="bg-zinc-900 border border-zinc-800 rounded-3xl p-5">
              <div className="flex items-center gap-2 text-xs font-black uppercase text-zinc-500 mb-4">
                <Key size={14} className="text-blue-500" /> Backup Data
              </div>
              <div className="space-y-4">
                <div className="flex gap-2">
                  <div className="flex-1 bg-black p-3 rounded-xl border border-zinc-800 font-mono text-[8px] truncate opacity-40">
                    {generateSaveKey()}
                  </div>
                  <button onClick={copyKey} className="p-3 bg-blue-600 rounded-xl"><Copy size={18} /></button>
                </div>
                <div className="pt-2 border-t border-zinc-800">
                  <textarea 
                    value={saveKeyInput} onChange={(e) => setSaveKeyInput(e.target.value)}
                    placeholder="Paste key here..."
                    className="w-full bg-black border border-zinc-800 rounded-xl p-3 text-[10px] h-16 mb-2 outline-none focus:border-blue-500"
                  />
                  <button onClick={importKey} className="w-full py-3 bg-zinc-800 rounded-xl font-black uppercase text-[10px] hover:bg-zinc-700 transition-colors">Import Key</button>
                </div>
                {syncStatus && <p className="text-center text-xs font-bold text-blue-400 animate-pulse">{syncStatus}</p>}
              </div>
            </div>
          </div>
        )}
      </div>

      {/* FOOTER NAV (Not scaled to ensure touch targets stay consistent, but layout remains pro) */}
      <div className="fixed bottom-0 left-0 right-0 h-20 bg-black/80 backdrop-blur-xl border-t border-zinc-900 flex items-center justify-around px-8 z-40">
        <button onClick={() => setActiveView('workout')} className={`flex flex-col items-center gap-1 ${activeView === 'workout' ? 'text-blue-500' : 'text-zinc-600'}`}>
          <Dumbbell size={24} /><span className="text-[8px] font-black uppercase">Workout</span>
        </button>
        <button onClick={() => setActiveView('habits')} className={`flex flex-col items-center gap-1 ${activeView === 'habits' ? 'text-blue-500' : 'text-zinc-600'}`}>
          <Heart size={24} /><span className="text-[8px] font-black uppercase">Habits</span>
        </button>
        <button onClick={() => setActiveView('settings')} className={`flex flex-col items-center gap-1 ${activeView === 'settings' ? 'text-blue-500' : 'text-zinc-600'}`}>
          <SettingsIcon size={24} /><span className="text-[8px] font-black uppercase">Settings</span>
        </button>
      </div>

      {/* FOCUS MODAL (Subsection) - Now Scale-Aware */}
      {focusTask && (
        <div className="fixed inset-0 bg-black z-[100] flex flex-col overflow-y-auto">
          {/* Internal Scale Container for Subsection */}
          <div 
            style={{ transform: `scale(${visualScale})`, transformOrigin: 'top center' }}
            className="flex-1 flex flex-col items-center p-8 max-w-md mx-auto w-full min-h-full"
          >
            <div className="w-full flex justify-between items-center mb-12">
              <button onClick={() => setFocusTask(null)} className="p-4 bg-zinc-900 rounded-3xl text-zinc-400"><X size={24} /></button>
              <span className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Training Focus</span>
              <div className="w-12" />
            </div>

            <div className="w-24 h-24 rounded-[3rem] bg-blue-600 flex items-center justify-center text-5xl mb-6 shadow-2xl shadow-blue-500/20">{focusTask.icon}</div>
            <h2 className="text-4xl font-black italic uppercase tracking-tighter mb-4 text-center leading-none">{focusTask.name}</h2>
            
            {focusTask.kneeWarning && (
              <div className="bg-orange-500/10 border border-orange-500/30 text-orange-500 p-3 rounded-2xl mb-8 flex items-center gap-2 text-xs font-bold">
                <AlertTriangle size={16} /> Knee Guard Active: Stop if painful!
              </div>
            )}

            <div className="w-64 h-64 rounded-full border-[12px] border-zinc-900 flex flex-col items-center justify-center relative mb-12 flex-shrink-0">
              <div className="text-6xl font-black tabular-nums tracking-tighter leading-none">
                {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
              </div>
              <p className="text-[10px] font-black uppercase text-zinc-600 tracking-widest mt-2">{focusTask.type === 'time' ? 'Timer' : 'Rest period'}</p>
              
              <div className="absolute -bottom-8 flex gap-4">
                <button 
                  onClick={() => {
                    if (!isTimerRunning && timeLeft === 0) {
                      setTimeLeft(typeof focusTask.goal === 'number' ? focusTask.goal : 60);
                      setIsTimerRunning(true);
                    } else setIsTimerRunning(!isTimerRunning);
                  }} 
                  className={`w-16 h-16 rounded-full flex items-center justify-center shadow-xl transition-transform active:scale-90 ${isTimerRunning ? 'bg-white text-black' : 'bg-blue-600 text-white'}`}
                >
                  {isTimerRunning ? <Pause fill="currentColor" /> : <Play fill="currentColor" className="ml-1" />}
                </button>
                <button 
                  onClick={() => { setIsTimerRunning(false); setTimeLeft(0); }} 
                  className="w-16 h-16 bg-zinc-900 text-zinc-500 rounded-full flex items-center justify-center active:scale-90 transition-transform"
                >
                  <RotateCcw size={20} />
                </button>
              </div>
            </div>

            <div className="flex gap-4 mb-12">
               {[...Array(focusTask.sets || 1)].map((_, i) => (
                 <div 
                   key={i}
                   onClick={() => setSetCounts(p => ({ ...p, [focusTask.id + focusTask.day + i]: !p[focusTask.id + focusTask.day + i] }))}
                   className={`w-14 h-14 rounded-3xl flex items-center justify-center font-black transition-all border-2 ${
                     setCounts[focusTask.id + focusTask.day + i] ? 'bg-blue-600 border-blue-400 scale-110 shadow-lg shadow-blue-500/20' : 'bg-zinc-900 border-zinc-800 text-zinc-700'
                   }`}
                 >
                   {i + 1}
                 </div>
               ))}
            </div>

            <button 
              onClick={() => { setCompletedTasks(p => ({...p, [focusTask.id + focusTask.day]: !p[focusTask.id + focusTask.day]})); setFocusTask(null); }}
              className={`w-full py-6 rounded-[2.5rem] font-black italic uppercase tracking-widest text-lg transition-all active:scale-95 ${completedTasks[focusTask.id + focusTask.day] ? 'bg-zinc-900 text-zinc-600' : 'bg-blue-600 text-white shadow-xl shadow-blue-500/20'}`}
            >
              {completedTasks[focusTask.id + focusTask.day] ? 'Unmark Task' : 'Confirm Done'}
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;

